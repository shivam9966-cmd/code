import pandas as pd
import numpy as np


def compute_yoy_variance(current_value, prev_value):
    if prev_value == 0 or pd.isna(prev_value):
        return None
    return round(((current_value - prev_value) / prev_value) * 100, 2)



def compute_contribution(df, level_col, kpi_col="amount", top_n=None):
    contrib = (
        df.groupby(level_col)[kpi_col].sum()
          .sort_values(ascending=False)
    )

    if top_n:  
        contrib = contrib.head(top_n)

    total = contrib.sum()
    if total == 0:
        return {}

    percent = (contrib / total * 100).round(2).to_dict()
    return percent



def generate_business_summary(df, year, month, version="L6", scenario="Actual"):
    level_col = f"account_{version}_Description"
    prev_year = f"FY{int(year.replace('FY','')) - 1}"

    # VALIDATION
    if level_col not in df.columns:
        raise ValueError(f"Column {level_col} not found in dataframe")


    df_selected = df[
        (df["YEAR"] == year) &
        (df["DATE"].dt.month == month) &
        (df["SCENARIO"] == scenario)
    ]

    df_prev = df[
        (df["YEAR"] == prev_year) &
        (df["DATE"].dt.month == month) &
        (df["SCENARIO"] == scenario)
    ]

 
    rev_current = df_selected[df_selected[level_col]=="Revenue"]["amount"].sum()
    opex_current = df_selected[df_selected[level_col]=="Operating Expenses"]["amount"].sum()
    ebitda_current = rev_current - opex_current

    rev_prev = df_prev[df_prev[level_col]=="Revenue"]["amount"].sum()
    opex_prev = df_prev[df_prev[level_col]=="Operating Expenses"]["amount"].sum()
    ebitda_prev = rev_prev - opex_prev

 
    rev_yoy = compute_yoy_variance(rev_current, rev_prev)
    opex_yoy = compute_yoy_variance(opex_current, opex_prev)
    ebitda_yoy = compute_yoy_variance(ebitda_current, ebitda_prev)

    
    rev_contrib = compute_contribution(
        df_selected[df_selected[level_col]=="Revenue"], 
        level_col="account_L6_Description" if version=="L6" else "account_L7_Description"
    )

    opex_contrib = compute_contribution(
        df_selected[df_selected[level_col]=="Operating Expenses"],
        level_col="account_L6_Description" if version=="L6" else "account_L7_Description",
        top_n=3
    )


    summary = {
        "Revenue": {
            "selected_amount": round(rev_current, 2),
            "variance_percent_yoy": rev_yoy,
            "contribution": rev_contrib
        },
        "OPEX": {
            "selected_amount": round(opex_current, 2),
            "variance_percent_yoy": opex_yoy,
            "contribution": opex_contrib
        },
        "EBITDA": {
            "selected_amount": round(ebitda_current, 2),
            "variance_percent_yoy": ebitda_yoy,
            "contribution": None
        }
    }

    return summary




















summary = generate_business_summary(
    df=df, 
    year="FY25", 
    month=5, 
    version="L6",      # or "L7"
    scenario="Actual"  # or "Plan"
)

summary
