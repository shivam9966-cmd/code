import pandas as pd
import json
import calendar
from typing import Optional
from openai import AzureOpenAI


AZURE_OPENAI_ENDPOINT = "https://AIHUB-TRAINING-OAISVC.openai.azure.com/"
AZURE_OPENAI_API_KEY = "YOUR_KEY"
AZURE_OPENAI_API_VERSION = "2024-12-01-preview"
AZURE_DEPLOYMENT_NAME = "gpt-4o-mini"

client = AzureOpenAI(
    api_key=AZURE_OPENAI_API_KEY,
    api_version=AZURE_OPENAI_API_VERSION,
    azure_endpoint=AZURE_OPENAI_ENDPOINT,
)


MONTH_MAP = {
    "Jan": 1, "Feb": 2, "Mar": 3, "Apr": 4,
    "May": 5, "Jun": 6, "Jul": 7, "Aug": 8,
    "Sep": 9, "Oct": 10, "Nov": 11, "Dec": 12
}



def prepare_dataframe(df):
    df = df.copy()

    # Clean descriptions (remove spaces + proper case)
    df["account_L5_Description"] = (
        df["account_L5_Description"].astype(str).str.strip().str.title()
    )
    df["account_L6_Description"] = df["account_L6_Description"].astype(str).str.strip()

    df["SCENARIO"] = df["SCENARIO"].astype(str).str.strip().str.title()
    df["VERSION"] = df["VERSION"].astype(str).str.strip().str.title()

    # Convert PERIOD to numeric month
    df["PERIOD"] = df["PERIOD"].astype(str).str.strip().str.title()
    df["PERIOD_NUM"] = df["PERIOD"].map(MONTH_MAP)

    return df



def yoy_variance(curr, prev):
    if prev == 0 or pd.isna(prev):
        return None
    return round(((curr - prev) / prev) * 100, 2)



def contribution(df, level_col: str, top_n: Optional[int] = None):
    if df.empty:
        return {}

    grouped = df.groupby(level_col)["Amount"].sum().sort_values(ascending=False)

    if top_n:
        grouped = grouped.head(top_n)

    total = grouped.sum()
    if total == 0:
        return {}

    return {k: round((v / total) * 100, 2) for k, v in grouped.items()}



def compute_business_metrics(df, year, month, version, scenario):

    df = prepare_dataframe(df)

    # Fix year & previous year
    fy_num = int(year.replace("FY", ""))
    prev_year = f"FY{fy_num - 1}"

    # Filter current period
    df_curr = df[
        (df["YEAR"] == year)
        & (df["PERIOD_NUM"] == month)
        & (df["SCENARIO"] == scenario)
        & (df["VERSION"] == version)
    ]

    # Filter previous year same month
    df_prev = df[
        (df["YEAR"] == prev_year)
        & (df["PERIOD_NUM"] == month)
        & (df["SCENARIO"] == scenario)
        & (df["VERSION"] == version)
    ]

 
    rev_curr = df_curr[df_curr["account_L5_Description"] == "Revenue"]["Amount"].sum()
    opex_curr = df_curr[df_curr["account_L5_Description"] == "Operating Expenses"]["Amount"].sum()
    ebitda_curr = rev_curr - opex_curr

    rev_prev = df_prev[df_prev["account_L5_Description"] == "Revenue"]["Amount"].sum()
    opex_prev = df_prev[df_prev["account_L5_Description"] == "Operating Expenses"]["Amount"].sum()
    ebitda_prev = rev_prev - opex_prev

    # YOY %
    rev_yoy = yoy_variance(rev_curr, rev_prev)
    opex_yoy = yoy_variance(opex_curr, opex_prev)
    ebitda_yoy = yoy_variance(ebitda_curr, ebitda_prev)

    # L6 Contribution breakdown
    rev_contrib = contribution(
        df_curr[df_curr["account_L5_Description"] == "Revenue"],
        level_col="account_L6_Description"
    )

    opex_contrib = contribution(
        df_curr[df_curr["account_L5_Description"] == "Operating Expenses"],
        level_col="account_L6_Description",
        top_n=3
    )


    return {
        "Revenue": {
            "selected_amount": round(rev_curr, 2),
            "variance_percent_yoy": rev_yoy,
            "contribution": rev_contrib,
        },
        "OPEX": {
            "selected_amount": round(opex_curr, 2),
            "variance_percent_yoy": opex_yoy,
            "contribution": opex_contrib,
        },
        "EBITDA": {
            "selected_amount": round(ebitda_curr, 2),
            "variance_percent_yoy": ebitda_yoy,
            "contribution": None,
        },
        "meta": {
            "year": year,
            "prev_year": prev_year,
            "month": month,
            "month_name": calendar.month_name[month],
            "version": version,
            "scenario": scenario,
        }
    }



def generate_llm_business_summary(metrics):

    prompt = f"""
    Create a crisp FP&A business summary from this JSON:

    {json.dumps(metrics, indent=2)}

    Rules:
    - Provide sharp insights for Revenue, OPEX, and EBITDA.
    - Include YoY movement explanation.
    - Include contribution drivers (L6 heads) for Revenue & OPEX.
    - Tone must sound like CFO deck bullets.
    - No long sentences. No fluff.
    - Return ONLY valid JSON of this structure:

    {{
      "Revenue": ["bullet1", "bullet2"],
      "OPEX": ["bullet1", "bullet2"],
      "EBITDA": ["bullet1", "bullet2"]
    }}
    """

    resp = client.chat.completions.create(
        model=AZURE_DEPLOYMENT_NAME,
        messages=[{"role": "user", "content": prompt}],
        temperature=0.3,
    )

    try:
        return json.loads(resp.choices[0].message.content)
    except:
        return {"Revenue": [], "OPEX": [], "EBITDA": []}



def generate_full_business_summary(df, year, month, version, scenario):
    metrics = compute_business_metrics(df, year, month, version, scenario)
    narrative = generate_llm_business_summary(metrics)
    return {"metrics": metrics, "narrative": narrative}
