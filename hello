import pandas as pd
import json
from llama_index.llms.azure_openai import AzureOpenAI
from llama_index.core import Settings

llm = AzureOpenAI(
    model="gpt-4o-mini",
    deployment_name="XXX",
    api_key="XXX",
    azure_endpoint="XXX",
    api_version="XXX",
    max_tokens=2000,
    temperature=0.2
)

Settings.llm = llm


BUSINESS_PROMPT = """
You are an FP&A leader.

You will be given aggregated financial data for one category (Revenue, Opex, or EBITDA).
Generate a Power BI dashboard–style *business narrative summary*.

FORMAT STRICTLY AS:

<Title>
• Bullet 1  
• Bullet 2  
• Bullet 3  

RULES:
- DO NOT mention Revenue when summarizing Opex.
- DO NOT mention Opex when summarizing Revenue.
- DO NOT mention Revenue or Opex when summarizing EBITDA.
- Must sound like a senior FP&A update.
- 2–3 bullets only.
- Very crisp. Max 20 words per bullet.
- No JSON. No quotes. No code.
- Output must be clean text ONLY.

Here is the data you must summarize:
{data}
"""


def generate_narrative(category, data_dict):
    prompt = BUSINESS_PROMPT.format(data=json.dumps(data_dict, indent=2))

    response = llm.complete(prompt)

    return response.text.strip()


def generate_business_narrative(df, year, months, level="L6"):
    usecases = generate_usecases(df, year, months, level=level)

    output = "\n\n"  # final formatted text

    output += "### Revenue\n"
    output += generate_narrative("Revenue", usecases["Revenue"])
    output += "\n\n"

    output += "### Opex\n"
    output += generate_narrative("OPEX", usecases["OPEX"])
    output += "\n\n"

    
    output += "### EBITDA\n"
    output += generate_narrative("EBITDA", usecases["EBITDA"])
    output += "\n\n"

    return output
