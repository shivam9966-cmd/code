import pandas as pd
from typing import Dict, Any

def compute_kpi_snapshot(
    df: pd.DataFrame,
    year: int,
    month: int,
    level: str = "L6",
    date_col: str = "DATE",
    amount_col: str = "Amount",
    bucket_col: str = "account_L5_Description",
    level_map: Dict[str, str] = None,
    scenario_col: str = "SCENARIO",
) -> Dict[str, Any]:
    """
    Compute KPI snapshot for Revenue, Opex, EBITDA for a given year+month.

    Output for each KPI:
    - actual_amount          (SCENARIO = 'Actual')
    - plan_amount            (SCENARIO = 'Plan')
    - variance_percent       ((actual - plan) / plan * 100)
    - l6_contribution_percent (dict of L6 heads -> % of total, where applicable)

    Revenue: show ALL L6 heads
    Opex:    show TOP 3 L6 heads by actual amount
    EBITDA:  no L6 breakdown
    """

  
    if level_map is None:
        level_map = {
            "L6": "account_L6_Description",
            "L7": "account_L7_Description",
        }
    if level not in level_map:
        raise ValueError("level must be 'L6' or 'L7'")

    level_col = level_map[level]

    
    df = df.copy()
    df[date_col] = pd.to_datetime(df[date_col])
    df[level_col] = df[level_col].astype(str).str.strip()
-
    mask = (df[date_col].dt.year == year) & (df[date_col].dt.month == month)
    df_month = df[mask]

    # Split actual vs plan
    df_actual = df_month[df_month[scenario_col] == "Actual"].copy()
    df_plan   = df_month[df_month[scenario_col] == "Plan"].copy()

    # Helper to get sum by bucket
    def kpi_sum(sub_df, bucket_value):
        return float(
            sub_df[sub_df[bucket_col] == bucket_value][amount_col].sum()
        )

 
    # In your data: Revenue ↔ 'Revenue', Opex ↔ 'Operating Expenses'
    rev_actual = kpi_sum(df_actual, "Revenue")
    rev_plan   = kpi_sum(df_plan, "Revenue")

    opex_actual = kpi_sum(df_actual, "Operating Expenses")
    opex_plan   = kpi_sum(df_plan, "Operating Expenses")

    # EBITDA derived
    ebitda_actual = rev_actual - opex_actual
    ebitda_plan   = rev_plan - opex_plan

    def variance_pct(actual, plan):
        if plan == 0:
            return None
        return round((actual - plan) / plan * 100, 2)
]
    rev_l6_contrib = {}
    if rev_actual != 0:
        rev_l6 = (
            df_actual[df_actual[bucket_col] == "Revenue"]
            .groupby(level_col)[amount_col]
            .sum()
            .reset_index()
        )
        rev_l6["contrib_pct"] = rev_l6[amount_col] / rev_actual * 100
        # show all heads
        for _, row in rev_l6.iterrows():
            rev_l6_contrib[str(row[level_col])] = round(row["contrib_pct"], 2)

   
    opex_l6_contrib = {}
    if opex_actual != 0:
        opex_l6 = (
            df_actual[df_actual[bucket_col] == "Operating Expenses"]
            .groupby(level_col)[amount_col]
            .sum()
            .reset_index()
        )
        opex_l6 = opex_l6.sort_values(amount_col, ascending=False)
        opex_l6["contrib_pct"] = opex_l6[amount_col] / opex_actual * 100
        # keep top 3
        opex_l6_top3 = opex_l6.head(3)
        for _, row in opex_l6_top3.iterrows():
            opex_l6_contrib[str(row[level_col])] = round(row["contrib_pct"], 2)

 
    result = {
        "Revenue": {
            "actual_amount": rev_actual,
            "plan_amount": rev_plan,
            "variance_percent": variance_pct(rev_actual, rev_plan),
            "level_contribution_percent": rev_l6_contrib,  
        },
        "OPEX": {
            "actual_amount": opex_actual,
            "plan_amount": opex_plan,
            "variance_percent": variance_pct(opex_actual, opex_plan),
            "level_contribution_percent": opex_l6_contrib, 
        },
        "EBITDA": {
            "actual_amount": ebitda_actual,
            "plan_amount": ebitda_plan,
            "variance_percent": variance_pct(ebitda_actual, ebitda_plan),
            "level_contribution_percent": None, 
        },
        "meta": {
            "year": year,
            "month": month,
            "level_used": level,
        },
    }

    return result



























snapshot = compute_kpi_snapshot(df["YEAR"] == "FY25")  AND  (df["DATE"].dt.month == 5)


from pprint import pprint
pprint(snapshot)
