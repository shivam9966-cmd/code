writer = final_df
if COALESCE_SINGLE_FILE and OUTPUT_FORMAT in ("parquet","csv"):
    writer = writer.coalesce(1)

w = writer.write.mode("overwrite")
if OUTPUT_FORMAT == "csv":
    w.format("csv").option("header","true").save(TARGET_PATH)
elif OUTPUT_FORMAT == "delta":
    w.format("delta").option("overwriteSchema","true").save(TARGET_PATH)
else:  # parquet
    w.format("parquet").save(TARGET_PATH)
